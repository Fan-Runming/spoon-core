<!-- static/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Relationship Spark Notebook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      min-height: 100vh;
    }

    .container {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr);
      gap: 24px;
      width: 100%;
      max-width: 1200px;
      margin: 32px auto;
      padding: 0 16px;
    }

    .panel {
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
      border: 1px solid #1e293b;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    h1 {
      font-size: 22px;
      margin: 0 0 4px;
    }

    h2 {
      font-size: 18px;
      margin: 0 0 8px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 10px;
      font-size: 13px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    .chat-window {
      /* å›ºå®šé«˜åº¦ï¼Œé¿å…èŠå¤©æ¡†éšå†…å®¹ä¸æ–­æ‹‰é•¿ã€‚å†…éƒ¨å¯æ»šåŠ¨ */
      flex: none;
      height: 340px;
      border-radius: 12px;
      border: 1px solid #1e293b;
      background: #020617;
      padding: 10px 10px 6px;
      overflow-y: auto;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .chat-message {
      margin-bottom: 8px;
      max-width: 90%;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .chat-message.user {
      align-self: flex-end;
    }

    .chat-message.agent {
      align-self: flex-start;
    }

    .bubble {
      display: inline-block;
      padding: 7px 10px;
      border-radius: 12px;
      /* æ–‡æœ¬å·¦å¯¹é½ï¼ˆæ°”æ³¡åœ¨å³ä¾§ï¼Œä½†æ–‡å­—å·¦å¯¹é½ä»¥æé«˜å¯è¯»æ€§ï¼‰ */
      text-align: left;
    }

    .bubble-user {
      background: #22c55e;
      color: #022c22;
      border-bottom-right-radius: 2px;
    }

    .bubble-agent {
      background: #0f172a;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      border-bottom-left-radius: 2px;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    /* å·¦å³è¡Œå†…ï¼šè¾“å…¥æ¡† + è¯­éŸ³/ä¸Šä¼ /å‘é€æŒ‰é’® */
    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      font-size: 13px;
      box-sizing: border-box;
    }

    .icon-btn {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #334155;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* å½•éŸ³ä¸­çŠ¶æ€æ ·å¼ */
    .icon-btn.listening {
      background: linear-gradient(135deg, rgba(34,197,94,0.12), rgba(14,165,233,0.08));
      border-color: #22c55e;
      color: #bbf7d0;
      box-shadow: 0 4px 10px rgba(34,197,94,0.06);
    }

    button {
      padding: 8px 13px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #0b1120;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      min-height: 16px;
    }

    .card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1e293b;
      padding: 14px 16px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 17px;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 2px;
    }

    .card-subtitle {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .section-label {
      font-size: 12px;
      font-weight: 600;
      color: #a5b4fc;
      margin-bottom: 4px;
    }

    .section-text {
      font-size: 13px;
      color: #e5e7eb;
      white-space: pre-wrap;
      margin-bottom: 8px;
    }

    .tag-row {
      margin-bottom: 6px;
    }

    .tag-group-label {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin: 2px 4px 2px 0;
    }

    .tag-personality {
      background: rgba(34,197,94,0.12);
      border: 1px solid rgba(34,197,94,0.65);
      color: #bbf7d0;
    }

    .tag-goal {
      background: rgba(249,115,22,0.12);
      border: 1px solid rgba(249,115,22,0.7);
      color: #fed7aa;
    }

    .tag-interest {
      background: rgba(56,189,248,0.12);
      border: 1px solid rgba(56,189,248,0.7);
      color: #bae6fd;
    }

    .tag-career {
      background: rgba(168,85,247,0.12);
      border: 1px solid rgba(168,85,247,0.7);
      color: #e9d5ff;
    }

    .card-meta {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 4px;
    }

    .people-list {
      margin-top: 8px;
      /* å›ºå®šä¸ºé¡µé¢é«˜åº¦çš„ 40%ï¼Œå½“å†…å®¹è¶…å‡ºæ—¶å†…éƒ¨å¯æ»šåŠ¨ */
      height: 40vh;
      overflow-y: auto;
      padding-right: 4px;
    }

    .people-list-title {
      font-size: 13px;
      font-weight: 600;
      color: #9ca3af;
      margin: 12px 0 4px;
    }

    .mini-card {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      margin-bottom: 6px;
      cursor: pointer;
      background: #020617;
      transition: border-color 0.15s, background 0.15s;
    }

    .mini-card:hover {
      border-color: #4b5563;
      background: #020617;
    }

    .mini-title {
      font-size: 13px;
      color: #e2e8f0;
      margin-bottom: 2px;
    }

    .mini-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å·¦ä¾§ï¼šå¯¹è¯å¼è¾“å…¥ -->
    <div class="panel">
      <h1>Relationship Spark Notebook</h1>
      <div class="subtitle">
        é€šè¿‡ä¸€æ®µå¯¹è¯ï¼ŒæŠŠä½ å’Œ Ta çš„æ•…äº‹è¯´å‡ºæ¥ã€‚<br />
        Agent ä¼šè‡ªåŠ¨æŠ½å–å§“åã€è”ç³»æ–¹å¼ã€å…³ç³»æ ‡ç­¾ï¼Œå¹¶åœ¨ç¼ºå¤±æ—¶å‘ä½ è¿½é—®ã€‚<br />
        å¦‚æœä½ æƒ³ä»å·²æœ‰äººç‰©ä¸­â€œæ‰¾äººâ€ï¼Œå¯ä»¥è¿™æ ·è¯´ï¼š<br />
        <span style="color:#a5b4fc;">ä¾‹å¦‚ï¼šâ€œæ‰¾æœ‰äººæœºäº¤äº’èƒŒæ™¯çš„äººèŠèŠâ€</span>
      </div>

      <label for="scene">Scene / åœºæ™¯</label>
      <select id="scene">
        <option value="stay_in_touch">ä¿æŒè”ç³»ï¼ˆstay in touchï¼‰</option>
        <option value="first_meeting">åˆæ¬¡è®¤è¯†ï¼ˆfirst meetingï¼‰</option>
        <option value="long_time_no_see">å¾ˆä¹…æ²¡è”ç³»ï¼ˆlong time no seeï¼‰</option>
        <option value="repair_tension">æƒ³ä¿®å¤å…³ç³»ï¼ˆrepair tensionï¼‰</option>
        <option value="uncertain">ä¸ç¡®å®šï¼Œåªæ˜¯æƒ³è®°å½•ï¼ˆuncertainï¼‰</option>
      </select>

      <div id="chat-window" class="chat-window"></div>

      <div class="chat-input-row">
        <input
          id="chat-input"
          class="chat-input"
          placeholder="è·Ÿæˆ‘è¯´è¯´ Ta å§ï¼Œæˆ–è€…ç›´æ¥è¯´ï¼šæ‰¾æœ‰äººæœºäº¤äº’èƒŒæ™¯çš„äººã€‚"
        />
        <button id="voice-btn" class="icon-btn" title="è¯­éŸ³è¾“å…¥">ğŸ¤</button>
        <button id="attach-btn" class="icon-btn" title="ä¸Šä¼ ç…§ç‰‡">ğŸ“·</button>
        <!-- éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ -->
        <input id="photo-input" type="file" accept="image/*" style="display:none" />
        <button id="new-btn" class="icon-btn" title="æ–°å»ºå¡ç‰‡">â•</button>
        <button id="send-btn">å‘é€</button>
      </div>

      <div class="status" id="status"></div>
    </div>

    <!-- å³ä¾§ï¼šå¡ç‰‡å±•ç¤º + åˆ—è¡¨ -->
    <div class="panel">
      <h2>âœ¨ å½“å‰äººç‰©å¡ç‰‡</h2>

      <div id="current-card" class="card">
        <div class="card-title">è¿˜æ²¡æœ‰å¡ç‰‡</div>
        <div class="card-subtitle">åœ¨å·¦è¾¹å¼€å§‹ä¸€æ®µå¯¹è¯ï¼Œç„¶åæˆ‘ä¼šå¸®ä½ ç”Ÿæˆå…³äº Ta çš„äººç‰©å¡ç‰‡ã€‚</div>
      </div>

      <div class="people-list-title">ğŸ“’ æˆ‘æœ€è¿‘è®°å½•çš„äºº</div>
      <div id="people-list" class="people-list">
        <!-- mini cards -->
      </div>
    </div>
  </div>

  <script>
    const sceneSelect = document.getElementById("scene");
    const chatWindow = document.getElementById("chat-window");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");
    const statusEl = document.getElementById("status");
    const currentCardEl = document.getElementById("current-card");
    const peopleListEl = document.getElementById("people-list");

    // å¯¹è¯å†å²
    const chatHistory = []; // { role: 'user' | 'agent', text: string }

    // è¿½é—®å¾—åˆ°çš„å…³é”®ä¿¡æ¯
    let knownName = null;
    let knownMainContact = null;

    // å½“å‰æ˜¯å¦åœ¨ç­‰ç”¨æˆ·å›ç­”æŸä¸ªè¿½é—®å­—æ®µ
    let pendingQuestion = null; // 'name' | 'main_contact' | null

    // â­ å½“å‰æ­£åœ¨ç¼–è¾‘çš„äººç‰© idï¼ˆç”¨äºæ›´æ–°åŒä¸€å¼ å¡ç‰‡ï¼‰
    let currentPersonId = null;

    function appendMessage(role, text) {
      chatHistory.push({ role, text });

      const msg = document.createElement("div");
      msg.className = `chat-message ${role}`;

      const bubble = document.createElement("div");
      bubble.className = `bubble ${role === "user" ? "bubble-user" : "bubble-agent"}`;
      bubble.textContent = text;

      msg.appendChild(bubble);
      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function composeContextText() {
      return chatHistory
        .map((m) => (m.role === "user" ? `User: ${m.text}` : `Agent: ${m.text}`))
        .join("\n");
    }

    function renderTags(type, tags) {
      if (!tags || tags.length === 0) return "";
      const classMap = {
        personality: "tag-personality",
        goal: "tag-goal",
        interest: "tag-interest",
        career: "tag-career",
      };
      const className = classMap[type] || "tag";
      const labelMap = {
        personality: "Personality / æ€§æ ¼",
        goal: "Goals / ç›®æ ‡",
        interest: "Interests / å…´è¶£",
        career: "Career / èŒä¸š/ä¸“ä¸š",
      };
      const label = labelMap[type] || type;

      const pills = tags
        .map((t) => `<span class="tag ${className}">${escapeHtml(t)}</span>`)
        .join("");

      return `
        <div class="tag-row">
          <div class="tag-group-label">${label}</div>
          <div>${pills}</div>
        </div>
      `;
    }

    function renderPersonCard(person) {
      const title = escapeHtml(person.card_title || "æœªå‘½åäººç‰©å¡ç‰‡");
      const nameLine = person.name ? escapeHtml(person.name) : "ï¼ˆæœªå¡«å†™å§“åï¼‰";
      const relation = person.relationship_to_me ? ` Â· ${escapeHtml(person.relationship_to_me)}` : "";
      const contact = person.main_contact ? `è”ç³»æ–¹å¼ï¼š${escapeHtml(person.main_contact)}` : "";
      const howWeMet = person.how_we_met ? `ç›¸è¯†æ–¹å¼ï¼š${escapeHtml(person.how_we_met)}` : "";
      const location = person.location ? `Ta å¤§æ¦‚åœ¨ï¼š${escapeHtml(person.location)}` : "";
      const lastContact = person.last_contact ? `ä¸Šæ¬¡è”ç³»ï¼š${escapeHtml(person.last_contact)}` : "";

      const suggestion = person.suggestion || "";
      const summary = person.summary || "";

      // å›¾ç‰‡å±•ç¤ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      let photosHtml = "";
      if (person.photos && person.photos.length > 0) {
        // æ³¨æ„ï¼šä¸è¦åœ¨å¤–å±‚æ¨¡æ¿å­—ç¬¦ä¸²ä¸­åµŒå¥—æœªè½¬ä¹‰çš„åå¼•å·ï¼Œä¼šå¯¼è‡´ JS è¯­æ³•é”™è¯¯
        const imgs = person.photos
          .map((p) => '<img src="' + escapeHtml(p) + '" style="width:100px;height:100px;object-fit:cover;border-radius:8px;border:1px solid #1f2937;"/>')
          .join("");
        photosHtml = '<div style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap">' + imgs + '</div>';
      }

      return `
        <div class="card">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px;">
            <div style="flex:1">
              <div class="card-title">${title}</div>
              <div class="card-subtitle">${nameLine}${relation}</div>
            </div>
          </div>

          ${photosHtml}

          ${renderTags("personality", person.personality_tags)}
          ${renderTags("goal", person.goal_tags)}
          ${renderTags("interest", person.interest_tags)}
          ${renderTags("career", person.career_tags)}

          <div class="section-label">Relationship Summary / å…³ç³»å°ç»“</div>
          <div class="section-text">${escapeHtml(summary)}</div>

          <div class="section-label">Next Step Suggestion / ä¸‹ä¸€æ­¥å¯ä»¥æ€ä¹ˆè”ç³» Ta</div>
          <div class="section-text">${escapeHtml(suggestion)}</div>

          <div class="card-meta">
            ${contact ? contact + " Â· " : ""}
            ${howWeMet ? howWeMet + " Â· " : ""}
            ${location ? location + " Â· " : ""}
            ${lastContact ? lastContact : ""}
          </div>
        </div>
      `;
    }

    function renderMiniCard(person) {
      const title = escapeHtml(person.card_title || "æœªå‘½åäººç‰©å¡ç‰‡");
      const subtitleParts = [];
      if (person.name) subtitleParts.push(escapeHtml(person.name));
      if (person.relationship_to_me) subtitleParts.push(escapeHtml(person.relationship_to_me));

      const subtitle = subtitleParts.join(" Â· ");

      const avatar = person.photos && person.photos.length > 0 ? `<img src="${escapeHtml(
        person.photos[0]
      )}" style="width:44px;height:44px;object-fit:cover;border-radius:8px;margin-right:8px;border:1px solid #1f2937;"/>` : "";

      return `
        <div class="mini-card" data-id="${person.id}" style="display:flex;align-items:center;">
          ${avatar}
          <div style="flex:1">
            <div class="mini-title">${title}</div>
            <div class="mini-subtitle">${subtitle || "è¿˜æ²¡æœ‰å¡«å†™å§“å/å…³ç³»"}</div>
          </div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function loadPeople() {
      try {
        const res = await fetch("/api/people");
        if (!res.ok) throw new Error("Failed to load people");
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          peopleListEl.innerHTML = `<div style="font-size:12px;color:#64748b;">è¿˜æ²¡æœ‰è®°å½•ä»»ä½•äººã€‚</div>`;
          return;
        }

        // åªæ˜¾ç¤ºæœ€è¿‘çš„ 5 æ¡è®°å½•ï¼ˆæ•°æ®å·²åœ¨åç«¯æŒ‰æ—¶é—´å€’åºè¿”å›ï¼‰
        const recent = data.slice(0, 5);
        peopleListEl.innerHTML = recent.map(renderMiniCard).join("");
        if (data.length > 5) {
          const moreEl = document.createElement("div");
          moreEl.style = "font-size:12px;color:#94a3b8;padding:6px 8px;border-top:1px dashed #1f2937;margin-top:6px;cursor:pointer;";
          moreEl.textContent = `æ˜¾ç¤ºæœ€è¿‘ ${data.length} æ¡ä¸­çš„å‰ 5 æ¡ï¼Œç‚¹å‡»æŸ¥çœ‹å…¨éƒ¨`;
          moreEl.addEventListener("click", () => {
            peopleListEl.innerHTML = data.map(renderMiniCard).join("");
            // é‡æ–°ç»‘å®šç‚¹å‡»
            peopleListEl.querySelectorAll(".mini-card").forEach((el) => {
              el.addEventListener("click", () => {
                const id = Number(el.getAttribute("data-id"));
                const person = data.find((p) => p.id === id);
                if (person) currentCardEl.innerHTML = renderPersonCard(person);
              });
            });
          });
          peopleListEl.appendChild(moreEl);
        }

        // ç‚¹å‡» mini card å±•ç¤ºåˆ°å½“å‰å¡ç‰‡åŒºåŸŸï¼ˆåˆå§‹ç»‘å®šï¼‰
        peopleListEl.querySelectorAll(".mini-card").forEach((el) => {
          el.addEventListener("click", () => {
            const id = Number(el.getAttribute("data-id"));
            const person = data.find((p) => p.id === id);
            if (person) {
              currentCardEl.innerHTML = renderPersonCard(person);
            }
          });
        });
      } catch (err) {
        console.error(err);
        peopleListEl.innerHTML = `<div style="font-size:12px;color:#f97373;">åŠ è½½äººç‰©åˆ—è¡¨å¤±è´¥ã€‚</div>`;
      }
    }

    async function callSpark() {
      const scene = sceneSelect.value;
      const context = composeContextText();

      if (!context.trim()) {
        statusEl.textContent = "å…ˆè·Ÿæˆ‘è¯´ä¸€ç‚¹å…³äº Ta çš„äº‹æƒ…å§ï½";
        return;
      }

      sendBtn.disabled = true;
      statusEl.textContent = "Thinking with your Relationship Spark Agentâ€¦";
      currentCardEl.innerHTML = `
        <div class="card-title">ç”Ÿæˆä¸­â€¦</div>
        <div class="card-subtitle">æˆ‘æ­£åœ¨æ¶ˆåŒ–ä½ è¯´çš„å†…å®¹ï¼Œå¸®ä½ æ•´ç†è¿™æ®µå…³ç³»ã€‚</div>
      `;

      try {
        const res = await fetch("/api/spark", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id: currentPersonId,  // â­ å‘Šè¯‰åç«¯å½“å‰æ˜¯æ›´æ–°å“ªä¸ªäººï¼ˆç¬¬ä¸€æ¬¡ä¸º nullï¼‰
            scene,
            context,
            name: knownName,
            main_contact: knownMainContact,
          }),
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`Server error: ${res.status} ${errText}`);
        }

        const data = await res.json();

        // â­ ä¿å­˜å½“å‰äººçš„ idï¼Œä»¥ä¾¿åç»­æ›´æ–°åŒä¸€å¼ å¡ç‰‡
        currentPersonId = data.id;

        currentCardEl.innerHTML = renderPersonCard(data);
        statusEl.textContent = "å®Œæˆ âœ” è¿™å¼ å¡ç‰‡å·²ç»è¢«è®°å½•åœ¨å³ä¸‹è§’åˆ—è¡¨ä¸­ï½";

        await loadPeople();

        // æ£€æŸ¥æ˜¯å¦ç¼ºå°‘å…³é”®ä¿¡æ¯ï¼šå§“å / ä¸»è¦è”ç³»æ–¹å¼
        if (!data.name && !knownName) {
          const q = "æˆ‘è¿˜ä¸çŸ¥é“ Ta çš„åå­—ï¼Œä½ æ–¹ä¾¿å‘Šè¯‰æˆ‘å—ï¼Ÿ";
          appendMessage("agent", q);
          pendingQuestion = "name";
        } else if (!data.main_contact && !knownMainContact) {
          const q = "é‚£é€šå¸¸ä½ æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼è”ç³» Ta çš„ï¼Ÿå¯ä»¥ç»™ä¸€ä¸ªä½ ä¹ æƒ¯ä½¿ç”¨çš„è”ç³»æ–¹å¼ï¼ˆæ¯”å¦‚å¾®ä¿¡å·ã€æ‰‹æœºå·æˆ–é‚®ç®±ï¼‰ã€‚";
          appendMessage("agent", q);
          pendingQuestion = "main_contact";
        } else {
          if (!pendingQuestion) {
            appendMessage("agent", "æˆ‘å·²ç»å¸®ä½ è®°å½•å¥½ Ta å•¦ï½ä¹‹åä½ ä¹Ÿå¯ä»¥ç»§ç»­è¡¥å……å…³äº Ta çš„æ•…äº‹ã€‚");
          }
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "è°ƒç”¨å¤±è´¥äº†ï¼Œæ£€æŸ¥ä¸€ä¸‹åç«¯æ˜¯å¦åœ¨è¿è¡Œï¼ˆuvicorn main:app --reloadï¼‰ã€‚";
        currentCardEl.innerHTML = `
          <div class="card-title">å‡ºé”™äº†</div>
          <div class="card-subtitle">è¯·åœ¨ç»ˆç«¯æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼Œæˆ–ç¨åé‡è¯•ã€‚</div>
        `;
      } finally {
        sendBtn.disabled = false;
      }
    }

    // åˆ¤æ–­ä¸€å¥è¯æ˜¯â€œæœç´¢è¯·æ±‚â€è¿˜æ˜¯â€œæè¿°äººç‰©â€
    function isSearchQuery(text) {
      const t = text.trim().toLowerCase();
      if (!t) return false;
      return (
        t.startsWith("æ‰¾") ||
        t.startsWith("æŸ¥æ‰¾") ||
        t.startsWith("search ") ||
        t.startsWith("find ")
      );
    }

    async function searchPeople(query) {
      statusEl.textContent = "æˆ‘åœ¨ä½ çš„äººç‰©å¡ç‰‡é‡Œå¸®ä½ æ‰¾æ‰¾çœ‹â€¦";

      try {
        const res = await fetch("/api/search_people?q=" + encodeURIComponent(query));
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`Server error: ${res.status} ${errText}`);
        }
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          appendMessage(
            "agent",
            "æˆ‘åœ¨ä½ å·²ç»è®°å½•çš„äººç‰©é‡Œæš‚æ—¶æ²¡æœ‰æ‰¾åˆ°å’Œè¿™å¥è¯ç‰¹åˆ«ç›¸å…³çš„äººã€‚ä½ å¯ä»¥æ¢ä¸ªå…³é”®è¯è¯•è¯•ï¼Œæ¯”å¦‚å…·ä½“ä¸€ç‚¹çš„æ–¹å‘ã€åŸå¸‚æˆ–å­¦æ ¡ã€‚"
          );
          statusEl.textContent = "";
          return;
        }

        // æ‹¼ä¸€æ®µæ¨èè¯
        let reply = "æˆ‘è§‰å¾—ä½ å¯ä»¥è€ƒè™‘è”ç³»è¿™äº›äººï¼š\n";
        reply += data
          .slice(0, 3)
          .map((p) => {
            const name = p.name || "ï¼ˆæœªå‘½åï¼‰";
            const rel = p.relationship_to_me ? `ï¼ˆ${p.relationship_to_me}ï¼‰` : "";
            const title = p.card_title ? ` â€” ${p.card_title}` : "";
            return `- ${name}${rel}${title}`;
          })
          .join("\n");

        appendMessage("agent", reply);

        // æŠŠç¬¬ä¸€ä¸ªåŒ¹é…çš„äººå±•ç¤ºåœ¨å³ä¾§å¡ç‰‡åŒº
        currentCardEl.innerHTML = renderPersonCard(data[0]);
        statusEl.textContent = "æˆ‘å·²ç»æ ¹æ®ä½ çš„æè¿°æ¨èäº†å‡ ä¸ªäººï¼Œä¹ŸæŠŠå…¶ä¸­ä¸€ä¸ªå±•ç¤ºåœ¨å³è¾¹å¡ç‰‡é‡Œäº†ï½";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "æœç´¢å¤±è´¥äº†ï¼Œå¯èƒ½æ˜¯åç«¯æ²¡æœ‰è¿è¡Œæˆ–ç½‘ç»œé—®é¢˜ã€‚";
      }
    }

    async function handleSend() {
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = "";

      appendMessage("user", text);

      // å¦‚æœå½“å‰åœ¨ç­‰ç”¨æˆ·å›ç­”å§“å / è”ç³»æ–¹å¼ï¼Œå°±æŠŠè¿™ä¸€å¥å½“æˆç­”æ¡ˆ
      if (pendingQuestion === "name") {
        knownName = text;
        pendingQuestion = null;
        appendMessage("agent", `å¥½çš„ï¼Œæˆ‘è®°ä¸‹æ¥äº†ï¼ŒTa çš„åå­—æ˜¯ ${text}ã€‚æˆ‘å†å¸®ä½ æ›´æ–°ä¸€ä¸‹äººç‰©å¡ç‰‡ï½`);
        await callSpark();
      } else if (pendingQuestion === "main_contact") {
        knownMainContact = text;
        pendingQuestion = null;
        appendMessage("agent", "å¥½çš„ï¼Œæˆ‘ä¼šç”¨è¿™ä¸ªä½œä¸ºä¸»è¦è”ç³»æ–¹å¼ã€‚è®©æˆ‘å†æ›´æ–°ä¸€ä¸‹è¿™å¼ å¡ç‰‡ã€‚");
        await callSpark();
      } else if (isSearchQuery(text)) {
        // â­ æœç´¢æ¨¡å¼ï¼šä¸ä¿®æ”¹å½“å‰äººç‰©ï¼Œç›´æ¥åœ¨å·²æœ‰å¡ç‰‡ä¸­æ‰¾äºº
        await searchPeople(text);
      } else {
        // æ™®é€šæè¿°ï¼šæ›´æ–° / åˆ›å»ºäººç‰©å¡ç‰‡
        await callSpark();
      }
    }

    sendBtn.addEventListener("click", handleSend);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // ---- è¯­éŸ³è¾“å…¥ & ç…§ç‰‡ä¸Šä¼ æ”¯æŒ ----
    const voiceBtn = document.getElementById("voice-btn");
    const attachBtn = document.getElementById("attach-btn");
    const photoInput = document.getElementById("photo-input");

    // ä¸Šä¼ å›¾ç‰‡å¹¶ï¼ˆå¦‚æœæœ‰ currentPersonIdï¼‰å…³è”
    async function uploadPhotoFile(file) {
      try {
        const fd = new FormData();
        fd.append("file", file);
        if (currentPersonId) fd.append("id", String(currentPersonId));

        statusEl.textContent = "æ­£åœ¨ä¸Šä¼ ç…§ç‰‡â€¦";
        const res = await fetch("/api/upload_photo", {
          method: "POST",
          body: fd,
        });
        if (!res.ok) throw new Error("ä¸Šä¼ å¤±è´¥");
        const j = await res.json();

        // é‡æ–°åŠ è½½äººç‰©åˆ—è¡¨å¹¶å°è¯•æŠŠè¯¥äººç‰©å±•ç¤ºå‡ºæ¥
        await loadPeople();
        if (j.id) {
          const peopleRes = await fetch("/api/people");
          const people = await peopleRes.json();
          const person = people.find((p) => p.id === j.id);
          if (person) currentCardEl.innerHTML = renderPersonCard(person);
          statusEl.textContent = "ç…§ç‰‡ä¸Šä¼ å¹¶å·²ä¿å­˜åˆ°è¯¥äººç‰©å¡ç‰‡ã€‚";
        } else {
          statusEl.textContent = "ç…§ç‰‡å·²ä¸Šä¼ ï¼ˆæœªå…³è”åˆ°äººç‰©ï¼‰ã€‚ä½ å¯ä»¥åœ¨åˆ›å»º/æ›´æ–°å¡ç‰‡æ—¶ä¿å­˜ã€‚";
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "ç…§ç‰‡ä¸Šä¼ å¤±è´¥ã€‚";
      }
    }

    attachBtn.addEventListener("click", () => photoInput.click());
    photoInput.addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) uploadPhotoFile(f);
      // reset so same file can be selected again
      photoInput.value = null;
    });

    // â€œæ–°å»ºå¡ç‰‡â€æŒ‰é’®ï¼šæ¸…é™¤å½“å‰ç¼–è¾‘çŠ¶æ€ï¼Œç¡®ä¿ä¸‹ä¸€æ¬¡å‘é€æ˜¯æ–°å»ºè€Œéæ›´æ–°
    const newBtn = document.getElementById("new-btn");
    if (newBtn) {
      newBtn.addEventListener("click", () => {
        currentPersonId = null;
        knownName = null;
        knownMainContact = null;
        pendingQuestion = null;
        // æ¸…ç©ºå¯¹è¯çª—å£å’Œå½“å‰å¡ç‰‡æ˜¾ç¤ºï¼ˆä¿ç•™å¼•å¯¼æç¤ºï¼‰
        chatHistory.length = 0;
        chatWindow.innerHTML = "";
        appendMessage(
          "agent",
          "å·²å¼€å§‹æ–°å»ºä¸€å¼ äººç‰©å¡ç‰‡ï¼šå…ˆé€‰åœºæ™¯ï¼Œç„¶åç”¨ä¸€ä¸¤å¥è¯è·Ÿæˆ‘è¯´è¿™ä¸ªäººã€‚"
        );
        currentCardEl.innerHTML = `
          <div class="card-title">è¿˜æ²¡æœ‰å¡ç‰‡</div>
          <div class="card-subtitle">åœ¨å·¦è¾¹å¼€å§‹ä¸€æ®µå¯¹è¯ï¼Œç„¶åæˆ‘ä¼šå¸®ä½ ç”Ÿæˆå…³äº Ta çš„äººç‰©å¡ç‰‡ã€‚</div>
        `;
      });
    }

  // è¯­éŸ³è¯†åˆ«ï¼ˆWeb Speech APIï¼‰
  let recognition = null;
  let recognizing = false;
  // å½“ç”¨æˆ·ç‚¹å‡»å¼€å§‹å½•éŸ³åç½®ä¸º trueï¼›ç”¨æˆ·ç‚¹å‡»åœæ­¢æˆ–å‡ºé”™åˆ™ä¸º false
  let recordingActive = false;
  // å­˜å‚¨æœ€åä¸€æ¬¡çš„æœ€ç»ˆè½¬å†™ï¼Œç”¨äºåœ¨åœæ­¢å½•éŸ³æ—¶æŠŠç»“æœå†™å…¥è¾“å…¥æ¡†
  let lastFinalTranscript = "";
    function setupRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return null;
      const r = new SpeechRecognition();
  r.lang = "zh-CN";
  // å°½é‡ä¿æŒè¿ç»­è¯†åˆ«ï¼Œå¿…è¦æ—¶åœ¨ onend è‡ªåŠ¨é‡å¯ä»¥ç»´æŒâ€œå½•éŸ³ä¸­â€çŠ¶æ€
  r.continuous = true;
  // å¯ç”¨ä¸­é—´ç»“æœä»¥ä¾¿å®æ—¶å›æ˜¾
  r.interimResults = true;
  r.maxAlternatives = 1;

      r.onend = () => {
        // onend åœ¨è¯†åˆ«ç»“æŸæˆ–è¢«ä¸­æ–­æ—¶è§¦å‘
        recognizing = false;
        voiceBtn.classList.remove('listening');
        voiceBtn.textContent = "ğŸ¤";

        // å¦‚æœç”¨æˆ·ä»å¸Œæœ›ä¿æŒå½•éŸ³ï¼ˆæœªä¸»åŠ¨ç‚¹å‡»åœæ­¢ï¼‰ï¼Œåˆ™åœ¨çŸ­å»¶è¿Ÿåé‡å¯è¯†åˆ«
        if (recordingActive) {
          // å°å»¶è¿Ÿå¯é¿å…æŸäº›æµè§ˆå™¨ç«‹å³æŠ¥é”™
          setTimeout(() => {
            try {
              recognition.start();
            } catch (e) {
              console.error('failed to restart recognition', e);
            }
          }, 250);
          // ç»§ç»­æ˜¾ç¤ºä¸ºå½•éŸ³çŠ¶æ€
          voiceBtn.classList.add('listening');
          voiceBtn.textContent = "â¹ï¸";
          statusEl.textContent = "æ­£åœ¨å¬å†™ï¼Œç‚¹å‡»éº¦å…‹é£ç»“æŸå½•éŸ³å¹¶å°†è½¬å†™å¡«å…¥è¾“å…¥æ¡†ã€‚";
          return;
        }

        // å¦åˆ™ï¼ˆç”¨æˆ·å·²åœæ­¢ï¼‰ä¼˜å…ˆæŠŠ lastFinalTranscript å†™å…¥è¾“å…¥æ¡†ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä¿æŒå·²æœ‰çš„ä¸­é—´æ–‡æœ¬
        if (lastFinalTranscript) {
          chatInput.value = lastFinalTranscript;
          statusEl.textContent = "è¯†åˆ«å·²ç»“æŸï¼Œç»“æœå·²å¡«å…¥è¾“å…¥æ¡†ï¼Œç‚¹å‡»å‘é€æˆ–å›è½¦æäº¤ã€‚";
        } else if (chatInput.value) {
          statusEl.textContent = "è¯†åˆ«å·²ç»“æŸï¼Œç»“æœå·²å¡«å…¥è¾“å…¥æ¡†ï¼Œç‚¹å‡»å‘é€æˆ–å›è½¦æäº¤ã€‚";
        } else {
          statusEl.textContent = "æœªè¯†åˆ«åˆ°è¯­éŸ³æˆ–è¯†åˆ«è¶…æ—¶ï¼Œè¯·é‡è¯•ã€‚";
        }
      };
      

      r.onerror = (e) => {
        console.error('SpeechRecognition error', e);
        recognizing = false;
        voiceBtn.classList.remove('listening');
        voiceBtn.textContent = "ğŸ¤";
        if (e && e.error === 'not-allowed') {
          statusEl.textContent = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­å…è®¸è®¿é—®éº¦å…‹é£ã€‚';
        } else if (e && e.error === 'no-speech') {
          statusEl.textContent = 'æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·å†è¯•ä¸€æ¬¡ã€‚';
        } else {
          statusEl.textContent = 'è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼ˆè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™æˆ–åˆ·æ–°é¡µé¢ï¼‰ã€‚';
        }
      };

      r.onresult = (ev) => {
        // æ±‡æ€»å¤šæ¡ç»“æœï¼Œæ˜¾ç¤ºä¸­é—´è½¬å†™å¹¶åœ¨æœ€ç»ˆç»“æœæ—¶è‡ªåŠ¨å‘é€
        let interim = '';
        let finalTranscript = '';
        for (let i = 0; i < ev.results.length; i++) {
          const res = ev.results[i];
          if (res.isFinal) {
            finalTranscript += res[0].transcript;
          } else {
            interim += res[0].transcript;
          }
        }
        // ä¼˜å…ˆæ˜¾ç¤ºæœ€ç»ˆæ–‡æœ¬ï¼Œå¦åˆ™æ˜¾ç¤ºä¸­é—´è¯†åˆ«
        const display = (finalTranscript || interim).trim();
        chatInput.value = display;
        // å¦‚æœæœ‰æœ€ç»ˆæ–‡æœ¬ï¼Œä»…å¡«å…¥è¾“å…¥æ¡†ï¼Œä¸è‡ªåŠ¨å‘é€ï¼ˆè®©ç”¨æˆ·è‡ªå·±ç¡®è®¤å¹¶å‘é€ï¼‰
      };
      return r;
    }

    voiceBtn.addEventListener("click", () => {
      if (!recognition) recognition = setupRecognition();
      if (!recognition) {
        statusEl.textContent = "å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼ˆè¯•è¯• Chrome/Edgeï¼‰ã€‚";
        return;
      }

      if (!recognizing) {
        // ç”¨æˆ·ä¸»åŠ¨å¼€å§‹å½•éŸ³
        recordingActive = true;
        try {
          recognition.start();
        } catch (e) {
          console.error('recognition.start error', e);
          statusEl.textContent = 'æ— æ³•å¯åŠ¨è¯­éŸ³è¯†åˆ«ï¼Œè¯·é‡è¯•æˆ–åˆ·æ–°é¡µé¢ã€‚';
          recordingActive = false;
        }
      } else {
        // ç”¨æˆ·ä¸»åŠ¨åœæ­¢å½•éŸ³ï¼ˆä¼šè§¦å‘ onendï¼‰
        recordingActive = false;
        try {
          recognition.stop();
        } catch (e) {
          console.error('recognition.stop error', e);
        }
      }
    });

    // é¡µé¢åŠ è½½æ—¶ï¼Œå¼•å¯¼ + åŠ è½½å·²æœ‰å¡ç‰‡åˆ—è¡¨
    appendMessage(
      "agent",
      "å—¨ï½å…ˆé€‰ä¸€ä¸ªå¤§è‡´åœºæ™¯ï¼Œç„¶åç”¨ä¸€ä¸¤å¥è¯è·Ÿæˆ‘è¯´è¯´è¿™ä¸ªäººã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬åœ¨å“ªé‡Œè®¤è¯†ã€Ta æ˜¯æ€æ ·çš„äººï¼Œä½ ç°åœ¨æƒ³è·Ÿ Ta ä¿æŒæ€æ ·çš„å…³ç³»ã€‚\n\nå¦‚æœä½ æƒ³ä»å·²ç»è®°å½•çš„äººé‡Œâ€œæ‰¾äººâ€ï¼Œå¯ä»¥ç›´æ¥è¯´ï¼šæ‰¾æœ‰äººæœºäº¤äº’èƒŒæ™¯çš„äººèŠèŠã€‚"
    );
    loadPeople();
  </script>
</body>
</html>
