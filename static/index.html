<!-- static/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Relationship Spark Notebook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      min-height: 100vh;
    }

    .container {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr);
      gap: 24px;
      width: 100%;
      max-width: 1200px;
      margin: 32px auto;
      padding: 0 16px;
    }

    .panel {
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
      border: 1px solid #1e293b;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    h1 {
      font-size: 22px;
      margin: 0 0 4px;
    }

    h2 {
      font-size: 18px;
      margin: 0 0 8px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 10px;
      font-size: 13px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    .chat-window {
      flex: 1;
      border-radius: 12px;
      border: 1px solid #1e293b;
      background: #020617;
      padding: 10px 10px 6px;
      overflow-y: auto;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .chat-message {
      margin-bottom: 8px;
      max-width: 90%;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .chat-message.user {
      align-self: flex-end;
      text-align: right;
    }

    .chat-message.agent {
      align-self: flex-start;
    }

    .bubble {
      display: inline-block;
      padding: 7px 10px;
      border-radius: 12px;
    }

    .bubble-user {
      background: #22c55e;
      color: #022c22;
      border-bottom-right-radius: 2px;
    }

    .bubble-agent {
      background: #0f172a;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      border-bottom-left-radius: 2px;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      font-size: 13px;
      box-sizing: border-box;
    }

    button {
      padding: 8px 13px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #0b1120;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      min-height: 16px;
    }

    .card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1e293b;
      padding: 14px 16px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 17px;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 2px;
    }

    .card-subtitle {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .section-label {
      font-size: 12px;
      font-weight: 600;
      color: #a5b4fc;
      margin-bottom: 4px;
    }

    .section-text {
      font-size: 13px;
      color: #e5e7eb;
      white-space: pre-wrap;
      margin-bottom: 8px;
    }

    .tag-row {
      margin-bottom: 6px;
    }

    .tag-group-label {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin: 2px 4px 2px 0;
    }

    .tag-personality {
      background: rgba(34,197,94,0.12);
      border: 1px solid rgba(34,197,94,0.65);
      color: #bbf7d0;
    }

    .tag-goal {
      background: rgba(249,115,22,0.12);
      border: 1px solid rgba(249,115,22,0.7);
      color: #fed7aa;
    }

    .tag-interest {
      background: rgba(56,189,248,0.12);
      border: 1px solid rgba(56,189,248,0.7);
      color: #bae6fd;
    }

    .tag-career {
      background: rgba(168,85,247,0.12);
      border: 1px solid rgba(168,85,247,0.7);
      color: #e9d5ff;
    }

    .card-meta {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 4px;
    }

    .people-list {
      margin-top: 8px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .people-list-title {
      font-size: 13px;
      font-weight: 600;
      color: #9ca3af;
      margin: 12px 0 4px;
    }

    .mini-card {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      margin-bottom: 6px;
      cursor: pointer;
      background: #020617;
      transition: border-color 0.15s, background 0.15s;
    }

    .mini-card:hover {
      border-color: #4b5563;
      background: #020617;
    }

    .mini-title {
      font-size: 13px;
      color: #e2e8f0;
      margin-bottom: 2px;
    }

    .mini-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å·¦ä¾§ï¼šå¯¹è¯å¼è¾“å…¥ -->
    <div class="panel">
      <h1>Relationship Spark Notebook</h1>
      <div class="subtitle">
        é€šè¿‡ä¸€æ®µå¯¹è¯ï¼ŒæŠŠä½ å’Œ Ta çš„æ•…äº‹è¯´å‡ºæ¥ã€‚<br />
        Agent ä¼šè‡ªåŠ¨æŠ½å–å§“åã€è”ç³»æ–¹å¼ã€å…³ç³»æ ‡ç­¾ï¼Œå¹¶åœ¨ç¼ºå¤±æ—¶å‘ä½ è¿½é—®ã€‚
      </div>

      <label for="scene">Scene / åœºæ™¯</label>
      <select id="scene">
        <option value="stay_in_touch">ä¿æŒè”ç³»ï¼ˆstay in touchï¼‰</option>
        <option value="first_meeting">åˆæ¬¡è®¤è¯†ï¼ˆfirst meetingï¼‰</option>
        <option value="long_time_no_see">å¾ˆä¹…æ²¡è”ç³»ï¼ˆlong time no seeï¼‰</option>
        <option value="repair_tension">æƒ³ä¿®å¤å…³ç³»ï¼ˆrepair tensionï¼‰</option>
        <option value="uncertain">ä¸ç¡®å®šï¼Œåªæ˜¯æƒ³è®°å½•ï¼ˆuncertainï¼‰</option>
      </select>

      <div id="chat-window" class="chat-window"></div>

      <div class="chat-input-row">
        <input
          id="chat-input"
          class="chat-input"
          placeholder="è·Ÿæˆ‘è¯´è¯´ Ta å§ï¼Œæ¯”å¦‚ï¼šæˆ‘ä»¬æ˜¯åœ¨æŸæ¬¡æ´»åŠ¨è®¤è¯†çš„ã€Ta æ˜¯æ€æ ·çš„äººã€ä½ ä»¬ç°åœ¨çš„çŠ¶æ€â€¦"
        />
        <button id="send-btn">å‘é€</button>
      </div>

      <div class="status" id="status"></div>
    </div>

    <!-- å³ä¾§ï¼šå¡ç‰‡å±•ç¤º + åˆ—è¡¨ -->
    <div class="panel">
      <h2>âœ¨ å½“å‰äººç‰©å¡ç‰‡</h2>

      <div id="current-card" class="card">
        <div class="card-title">è¿˜æ²¡æœ‰å¡ç‰‡</div>
        <div class="card-subtitle">åœ¨å·¦è¾¹å¼€å§‹ä¸€æ®µå¯¹è¯ï¼Œç„¶åæˆ‘ä¼šå¸®ä½ ç”Ÿæˆå…³äº Ta çš„äººç‰©å¡ç‰‡ã€‚</div>
      </div>

      <div class="people-list-title">ğŸ“’ æˆ‘æœ€è¿‘è®°å½•çš„äºº</div>
      <div id="people-list" class="people-list">
        <!-- mini cards -->
      </div>
    </div>
  </div>

  <script>
    const sceneSelect = document.getElementById("scene");
    const chatWindow = document.getElementById("chat-window");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");
    const statusEl = document.getElementById("status");
    const currentCardEl = document.getElementById("current-card");
    const peopleListEl = document.getElementById("people-list");

    // å¯¹è¯å†å²ï¼ˆåªè®°å½•ç”¨æˆ·å’Œ agent çš„æ–‡æœ¬ï¼Œåç«¯ç”¨æ‹¼æ¥åçš„æ–‡æœ¬ï¼‰
    const chatHistory = []; // { role: 'user' | 'agent', text: string }

    // é€šè¿‡è¿½é—®å¾—åˆ°çš„å…³é”®ä¿¡æ¯
    let knownName = null;
    let knownMainContact = null;

    // å½“å‰æ˜¯å¦åœ¨ç­‰ç”¨æˆ·å›ç­”æŸä¸ªè¿½é—®å­—æ®µ
    // 'name' | 'main_contact' | null
    let pendingQuestion = null;

    function appendMessage(role, text) {
      chatHistory.push({ role, text });

      const msg = document.createElement("div");
      msg.className = `chat-message ${role}`;

      const bubble = document.createElement("div");
      bubble.className = `bubble ${role === "user" ? "bubble-user" : "bubble-agent"}`;
      bubble.textContent = text;

      msg.appendChild(bubble);
      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function composeContextText() {
      // æŠŠå¯¹è¯å†å²æ‹¼æˆä¸€å¤§æ®µæ–‡æœ¬
      return chatHistory
        .map((m) => (m.role === "user" ? `User: ${m.text}` : `Agent: ${m.text}`))
        .join("\n");
    }

    function renderTags(type, tags) {
      if (!tags || tags.length === 0) return "";
      const classMap = {
        personality: "tag-personality",
        goal: "tag-goal",
        interest: "tag-interest",
        career: "tag-career",
      };
      const className = classMap[type] || "tag";
      const labelMap = {
        personality: "Personality / æ€§æ ¼",
        goal: "Goals / ç›®æ ‡",
        interest: "Interests / å…´è¶£",
        career: "Career / èŒä¸š/ä¸“ä¸š",
      };
      const label = labelMap[type] || type;

      const pills = tags
        .map((t) => `<span class="tag ${className}">${escapeHtml(t)}</span>`)
        .join("");

      return `
        <div class="tag-row">
          <div class="tag-group-label">${label}</div>
          <div>${pills}</div>
        </div>
      `;
    }

    function renderPersonCard(person) {
      const title = escapeHtml(person.card_title || "æœªå‘½åäººç‰©å¡ç‰‡");
      const nameLine = person.name ? escapeHtml(person.name) : "ï¼ˆæœªå¡«å†™å§“åï¼‰";
      const relation = person.relationship_to_me ? ` Â· ${escapeHtml(person.relationship_to_me)}` : "";
      const contact = person.main_contact ? `è”ç³»æ–¹å¼ï¼š${escapeHtml(person.main_contact)}` : "";
      const howWeMet = person.how_we_met ? `ç›¸è¯†æ–¹å¼ï¼š${escapeHtml(person.how_we_met)}` : "";
      const location = person.location ? `Ta å¤§æ¦‚åœ¨ï¼š${escapeHtml(person.location)}` : "";
      const lastContact = person.last_contact ? `ä¸Šæ¬¡è”ç³»ï¼š${escapeHtml(person.last_contact)}` : "";

      const suggestion = person.suggestion || "";
      const summary = person.summary || "";

      return `
        <div class="card">
          <div class="card-title">${title}</div>
          <div class="card-subtitle">${nameLine}${relation}</div>

          ${renderTags("personality", person.personality_tags)}
          ${renderTags("goal", person.goal_tags)}
          ${renderTags("interest", person.interest_tags)}
          ${renderTags("career", person.career_tags)}

          <div class="section-label">Relationship Summary / å…³ç³»å°ç»“</div>
          <div class="section-text">${escapeHtml(summary)}</div>

          <div class="section-label">Next Step Suggestion / ä¸‹ä¸€æ­¥å¯ä»¥æ€ä¹ˆè”ç³» Ta</div>
          <div class="section-text">${escapeHtml(suggestion)}</div>

          <div class="card-meta">
            ${contact ? contact + " Â· " : ""}
            ${howWeMet ? howWeMet + " Â· " : ""}
            ${location ? location + " Â· " : ""}
            ${lastContact ? lastContact : ""}
          </div>
        </div>
      `;
    }

    function renderMiniCard(person) {
      const title = escapeHtml(person.card_title || "æœªå‘½åäººç‰©å¡ç‰‡");
      const subtitleParts = [];
      if (person.name) subtitleParts.push(person.name);
      if (person.relationship_to_me) subtitleParts.push(person.relationship_to_me);

      const subtitle = subtitleParts.join(" Â· ");

      return `
        <div class="mini-card" data-id="${person.id}">
          <div class="mini-title">${title}</div>
          <div class="mini-subtitle">${subtitle || "è¿˜æ²¡æœ‰å¡«å†™å§“å/å…³ç³»"}</div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function loadPeople() {
      try {
        const res = await fetch("/api/people");
        if (!res.ok) throw new Error("Failed to load people");
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          peopleListEl.innerHTML = `<div style="font-size:12px;color:#64748b;">è¿˜æ²¡æœ‰è®°å½•ä»»ä½•äººã€‚</div>`;
          return;
        }

        peopleListEl.innerHTML = data.map(renderMiniCard).join("");

        // ç‚¹å‡» mini card å±•ç¤ºåˆ°å½“å‰å¡ç‰‡åŒºåŸŸ
        peopleListEl.querySelectorAll(".mini-card").forEach((el) => {
          el.addEventListener("click", () => {
            const id = Number(el.getAttribute("data-id"));
            const person = data.find((p) => p.id === id);
            if (person) {
              currentCardEl.innerHTML = renderPersonCard(person);
            }
          });
        });
      } catch (err) {
        console.error(err);
        peopleListEl.innerHTML = `<div style="font-size:12px;color:#f97373;">åŠ è½½äººç‰©åˆ—è¡¨å¤±è´¥ã€‚</div>`;
      }
    }

    async function callSpark() {
      const scene = sceneSelect.value;
      const context = composeContextText();

      if (!context.trim()) {
        statusEl.textContent = "å…ˆè·Ÿæˆ‘è¯´ä¸€ç‚¹å…³äº Ta çš„äº‹æƒ…å§ï½";
        return;
      }

      sendBtn.disabled = true;
      statusEl.textContent = "Thinking with your Relationship Spark Agentâ€¦";
      currentCardEl.innerHTML = `
        <div class="card-title">ç”Ÿæˆä¸­â€¦</div>
        <div class="card-subtitle">æˆ‘æ­£åœ¨æ¶ˆåŒ–ä½ è¯´çš„å†…å®¹ï¼Œå¸®ä½ æ•´ç†è¿™æ®µå…³ç³»ã€‚</div>
      `;

      try {
        const res = await fetch("/api/spark", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            scene,
            context,
            name: knownName,
            main_contact: knownMainContact,
          }),
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`Server error: ${res.status} ${errText}`);
        }

        const data = await res.json();
        currentCardEl.innerHTML = renderPersonCard(data);
        statusEl.textContent = "å®Œæˆ âœ” è¿™å¼ å¡ç‰‡å·²ç»è¢«è®°å½•åœ¨å³ä¸‹è§’åˆ—è¡¨ä¸­ï½";

        await loadPeople();

        // æ£€æŸ¥æ˜¯å¦ç¼ºå°‘å…³é”®ä¿¡æ¯ï¼šå§“å / ä¸»è¦è”ç³»æ–¹å¼
        if (!data.name && !knownName) {
          const q = "æˆ‘è¿˜ä¸çŸ¥é“ Ta çš„åå­—ï¼Œä½ æ–¹ä¾¿å‘Šè¯‰æˆ‘å—ï¼Ÿ";
          appendMessage("agent", q);
          pendingQuestion = "name";
        } else if (!data.main_contact && !knownMainContact) {
          const q = "é‚£é€šå¸¸ä½ æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼è”ç³» Ta çš„ï¼Ÿå¯ä»¥ç»™ä¸€ä¸ªä½ ä¹ æƒ¯ä½¿ç”¨çš„è”ç³»æ–¹å¼ï¼ˆæ¯”å¦‚å¾®ä¿¡å·ã€æ‰‹æœºå·æˆ–é‚®ç®±ï¼‰ã€‚";
          appendMessage("agent", q);
          pendingQuestion = "main_contact";
        } else {
          // ä¿¡æ¯æ¯”è¾ƒå®Œæ•´ï¼Œå¯ä»¥ç»™ä¸€ä¸ªæ¸©æŸ”çš„æ”¶å°¾æç¤ºï¼ˆå¯é€‰ï¼‰
          if (!pendingQuestion) {
            appendMessage("agent", "æˆ‘å·²ç»å¸®ä½ è®°å½•å¥½ Ta å•¦ï½ä¹‹åä½ ä¹Ÿå¯ä»¥ç»§ç»­è¡¥å……å…³äº Ta çš„æ•…äº‹ã€‚");
          }
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "è°ƒç”¨å¤±è´¥äº†ï¼Œæ£€æŸ¥ä¸€ä¸‹åç«¯æ˜¯å¦åœ¨è¿è¡Œï¼ˆuvicorn main:app --reloadï¼‰ã€‚";
        currentCardEl.innerHTML = `
          <div class="card-title">å‡ºé”™äº†</div>
          <div class="card-subtitle">è¯·åœ¨ç»ˆç«¯æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼Œæˆ–ç¨åé‡è¯•ã€‚</div>
        `;
      } finally {
        sendBtn.disabled = false;
      }
    }

    async function handleSend() {
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = "";

      appendMessage("user", text);

      // å¦‚æœå½“å‰åœ¨ç­‰ç”¨æˆ·å›ç­”å§“å / è”ç³»æ–¹å¼ï¼Œå°±æŠŠè¿™ä¸€å¥å½“æˆç­”æ¡ˆ
      if (pendingQuestion === "name") {
        knownName = text;
        pendingQuestion = null;
        // è¡¥ä¸€å¥ agent å°ç¡®è®¤
        appendMessage("agent", `å¥½çš„ï¼Œæˆ‘è®°ä¸‹æ¥äº†ï¼ŒTa çš„åå­—æ˜¯ ${text}ã€‚æˆ‘å†å¸®ä½ æ›´æ–°ä¸€ä¸‹äººç‰©å¡ç‰‡ï½`);
        await callSpark();
      } else if (pendingQuestion === "main_contact") {
        knownMainContact = text;
        pendingQuestion = null;
        appendMessage("agent", `å¥½çš„ï¼Œæˆ‘ä¼šç”¨è¿™ä¸ªä½œä¸ºä¸»è¦è”ç³»æ–¹å¼ã€‚è®©æˆ‘å†æ›´æ–°ä¸€ä¸‹è¿™å¼ å¡ç‰‡ã€‚`);
        await callSpark();
      } else {
        // æ™®é€šæè¿°ï¼šæŠŠæ–°çš„å¯¹è¯å‘ç»™åç«¯ï¼Œè®©å®ƒé‡æ–°æ•´ç†
        await callSpark();
      }
    }

    sendBtn.addEventListener("click", handleSend);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // é¡µé¢åŠ è½½æ—¶ï¼Œå…ˆæ¥ä¸€æ¡å¼•å¯¼æ¶ˆæ¯ + åŠ è½½å†å²äººç‰©
    appendMessage(
      "agent",
      "å—¨ï½å…ˆé€‰ä¸€ä¸ªå¤§è‡´åœºæ™¯ï¼Œç„¶åç”¨ä¸€ä¸¤å¥è¯è·Ÿæˆ‘è¯´è¯´è¿™ä¸ªäººã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬åœ¨å“ªé‡Œè®¤è¯†ã€Ta æ˜¯æ€æ ·çš„äººï¼Œä½ ç°åœ¨æƒ³è·Ÿ Ta ä¿æŒæ€æ ·çš„å…³ç³»ã€‚"
    );
    loadPeople();
  </script>
</body>
</html>
